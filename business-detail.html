<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Detail - Cash Flow Finder</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f8fafc; }
        
        /* Header */
        .header-bar {
            background: white;
            border-bottom: 1px solid #e5e7eb;
            padding: 15px 0;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.5rem;
            font-weight: bold;
            color: #2563eb;
        }
        .logo img { height: 40px; }
        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #6b7280;
            font-size: 0.875rem;
        }
        .breadcrumb a {
            color: #2563eb;
            text-decoration: none;
        }
        .breadcrumb a:hover {
            text-decoration: underline;
        }

        /* Main Content */
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            color: #2563eb;
            text-decoration: none;
            margin-bottom: 20px;
            font-weight: 500;
        }
        .back-link:hover {
            text-decoration: underline;
        }

        /* Business Header */
        .business-header {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .business-title {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }
        .business-title h1 {
            color: #1f2937;
            font-size: 2rem;
            margin: 0;
        }
        .quality-score {
            background: #10b981;
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.875rem;
        }
        .business-meta {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .meta-item {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #374151;
        }

        /* Content Grid */
        .content-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
        }
        
        /* Content Sections */
        .content-section {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .section-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .premium-badge {
            background: #fbbf24;
            color: #78350f;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        /* Financial Details */
        .financial-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }
        .financial-item {
            text-align: center;
            padding: 15px;
            background: #f9fafb;
            border-radius: 8px;
        }
        .financial-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #059669;
            margin-bottom: 5px;
        }
        .financial-label {
            font-size: 0.875rem;
            color: #6b7280;
        }

        /* Industry Analysis */
        .industry-stats {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        .stat-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 15px;
        }
        .stat-item {
            text-align: center;
        }
        .stat-value {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 3px;
        }
        .stat-label {
            font-size: 0.875rem;
            opacity: 0.9;
        }

        /* Location Analysis */
        .location-stats {
            background: #f0f9ff;
            border: 1px solid #0ea5e9;
            padding: 20px;
            border-radius: 8px;
        }
        .demo-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 15px;
        }
        .demo-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e0f2fe;
        }

        /* SBA Calculator */
        .calculator {
            background: #f0fdf4;
            border: 1px solid #22c55e;
            border-radius: 8px;
            padding: 20px;
        }
        .calc-inputs {
            display: grid;
            gap: 15px;
            margin: 15px 0;
        }
        .input-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .input-group label {
            font-weight: 600;
            color: #374151;
            font-size: 0.875rem;
        }
        .input-group input {
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 1rem;
        }
        .calc-result {
            background: white;
            padding: 15px;
            border-radius: 6px;
            margin-top: 15px;
            border-left: 4px solid #22c55e;
        }
        .calc-button {
            background: #2563eb;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
        }
        .calc-button:hover {
            background: #1d4ed8;
        }

        /* Affiliate Links */
        .affiliate-section {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }
        .affiliate-links {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        .affiliate-link {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 15px;
            background: white;
            border-radius: 6px;
            text-decoration: none;
            color: #92400e;
            font-weight: 500;
            transition: all 0.2s;
        }
        .affiliate-link:hover {
            background: #fbbf24;
            color: white;
        }

        /* Book Recommendations */
        .book-item {
            display: flex;
            gap: 12px;
            padding: 12px;
            background: white;
            border-radius: 8px;
            border: 1px solid #f59e0b;
            transition: all 0.2s;
            text-decoration: none;
            color: inherit;
        }
        .book-item:hover {
            box-shadow: 0 4px 8px rgba(245, 158, 11, 0.2);
            transform: translateY(-1px);
        }
        .book-cover {
            width: 60px;
            height: 80px;
            background: linear-gradient(135deg, #f59e0b, #d97706);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            flex-shrink: 0;
        }
        .book-info {
            flex: 1;
            min-width: 0;
        }
        .book-title {
            font-weight: 600;
            color: #92400e;
            font-size: 0.9rem;
            line-height: 1.3;
            margin-bottom: 4px;
        }
        .book-author {
            color: #78350f;
            font-size: 0.8rem;
            margin-bottom: 6px;
        }
        .book-description {
            color: #a16207;
            font-size: 0.75rem;
            line-height: 1.3;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .book-relevance {
            background: #059669;
            color: white;
            padding: 2px 6px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            align-self: flex-start;
            margin-left: auto;
        }

        /* Loading States */
        .loading {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }
        .error {
            text-align: center;
            padding: 40px;
            color: #dc2626;
            background: #fef2f2;
            border-radius: 8px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .content-grid {
                grid-template-columns: 1fr;
            }
            .business-meta {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Header Bar -->
    <div class="header-bar">
        <div class="header-content">
            <div class="logo">
                <img src="/favicon.svg" alt="Cash Flow Finder">
                <span>Cash Flow Finder</span>
            </div>
            <div class="breadcrumb">
                <a href="/">Browse</a>
                <span>→</span>
                <span>Business Detail</span>
            </div>
        </div>
    </div>

    <div class="container">
        <a href="/" class="back-link">← Back to Browse</a>
        
        <div id="businessContent" class="loading">
            Loading business details...
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBcUfOEiZtGqf5Gx9VBMTPF0mO4U0CQ-jI",
            authDomain: "cashflow-finder-v2.firebaseapp.com",
            projectId: "cashflow-finder-v2",
            storageBucket: "cashflow-finder-v2.appspot.com",
            messagingSenderId: "1049067161601",
            appId: "1:1049067161601:web:5ea046a4ae26c516285800"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        window.firebaseAuth = auth;
        window.onAuthStateChanged = onAuthStateChanged;
    </script>

    <script>
        let currentUser = null;
        let businessData = null;

        // Get business ID from URL
        function getBusinessId() {
            const path = window.location.pathname;
            const match = path.match(/\/business\/(\d+)/);
            return match ? match[1] : localStorage.getItem('selectedBusinessId');
        }

        // Check authentication
        function checkAuth() {
            window.onAuthStateChanged(window.firebaseAuth, async (user) => {
                if (user) {
                    const token = await user.getIdToken();
                    currentUser = {
                        id: user.uid,
                        email: user.email,
                        name: user.displayName || user.email,
                        subscription_tier: user.email === 'meredith@monkeyattack.com' ? 'enterprise' : 'starter',
                        email_verified: user.emailVerified
                    };
                    loadBusinessDetail();
                } else {
                    window.location.href = '/';
                }
            });
        }

        // Load business detail
        async function loadBusinessDetail() {
            const businessId = getBusinessId();
            if (!businessId) {
                showError('Business not found. Please select a business from the browse page.');
                return;
            }

            try {
                const token = await window.firebaseAuth.currentUser.getIdToken();
                const response = await fetch(`/api/business/${businessId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    businessData = data.data.business;
                    renderBusinessDetail();
                } else {
                    showError('Failed to load business details.');
                }
            } catch (error) {
                showError('Error loading business: ' + error.message);
            }
        }

        // Show error message
        function showError(message) {
            document.getElementById('businessContent').innerHTML = `
                <div class="error">${message}</div>
            `;
        }

        // Render business detail page
        function renderBusinessDetail() {
            const business = businessData.business || businessData;
            const recommendations = businessData.recommendations || {};
            const isEnterprise = currentUser.subscription_tier === 'enterprise';
            const isProfessional = currentUser.subscription_tier === 'professional' || isEnterprise;

            document.getElementById('businessContent').innerHTML = `
                <!-- Business Header -->
                <div class="business-header">
                    <div class="business-title">
                        <h1>${business.name}</h1>
                        <div class="quality-score">⭐ ${business.quality_score}/10</div>
                    </div>
                    <div class="business-meta">
                        <div class="meta-item">
                            <span>📍</span>
                            <span>${business.location?.city || 'Unknown'}, ${business.location?.state || 'Unknown'}</span>
                        </div>
                        <div class="meta-item">
                            <span>🏢</span>
                            <span>${business.industry}</span>
                        </div>
                        <div class="meta-item">
                            <span>📅</span>
                            <span>Established ${business.financial_data?.established_year || 'N/A'}</span>
                        </div>
                        <div class="meta-item">
                            <span>🔗</span>
                            <span>${business.source}</span>
                        </div>
                    </div>
                </div>

                <div class="content-grid">
                    <!-- Main Content -->
                    <div>
                        <!-- Financial Overview -->
                        <div class="content-section">
                            <h2 class="section-title">💰 Financial Overview</h2>
                            <div class="financial-grid">
                                <div class="financial-item">
                                    <div class="financial-value">$${(business.financial_data?.asking_price || 0).toLocaleString()}</div>
                                    <div class="financial-label">Asking Price</div>
                                </div>
                                ${isProfessional && business.financial_data?.annual_revenue ? `
                                <div class="financial-item">
                                    <div class="financial-value">$${business.financial_data.annual_revenue.toLocaleString()}</div>
                                    <div class="financial-label">Annual Revenue</div>
                                </div>
                                ` : ''}
                                ${isProfessional && business.financial_data?.cash_flow ? `
                                <div class="financial-item">
                                    <div class="financial-value">$${business.financial_data.cash_flow.toLocaleString()}</div>
                                    <div class="financial-label">Cash Flow</div>
                                </div>
                                ` : ''}
                            </div>
                            ${!isProfessional ? `
                                <div style="margin-top: 20px; padding: 15px; background: #fef3c7; border-radius: 8px; text-align: center;">
                                    <strong>🔒 Upgrade to Professional or Enterprise</strong><br>
                                    <small>See detailed financials, revenue, and cash flow data</small>
                                </div>
                            ` : ''}
                        </div>

                        <!-- ROI Analysis -->
                        ${isProfessional && business.roi_analysis ? `
                        <div class="content-section">
                            <h2 class="section-title">📊 ROI Analysis <span class="premium-badge">PREMIUM</span></h2>
                            <div class="financial-grid">
                                <div class="financial-item">
                                    <div class="financial-value">${business.roi_analysis.payback_period_months}</div>
                                    <div class="financial-label">Payback (Months)</div>
                                </div>
                                <div class="financial-item">
                                    <div class="financial-value">${business.roi_analysis.roi_percentage}%</div>
                                    <div class="financial-label">ROI Percentage</div>
                                </div>
                                <div class="financial-item">
                                    <div class="financial-value">${business.roi_analysis.risk_level}</div>
                                    <div class="financial-label">Risk Level</div>
                                </div>
                            </div>
                        </div>
                        ` : ''}

                        <!-- Industry Analysis -->
                        ${isEnterprise ? `
                        <div class="content-section">
                            <h2 class="section-title">🏭 Industry Analysis <span class="premium-badge">ENTERPRISE</span></h2>
                            <div class="industry-stats">
                                <h3>${business.industry} Market Overview</h3>
                                <div class="stat-grid">
                                    <div class="stat-item">
                                        <div class="stat-value">$2.4B</div>
                                        <div class="stat-label">Market Size</div>
                                    </div>
                                    <div class="stat-item">
                                        <div class="stat-value">+3.2%</div>
                                        <div class="stat-label">Annual Growth</div>
                                    </div>
                                    <div class="stat-item">
                                        <div class="stat-value">847</div>
                                        <div class="stat-label">Avg. Businesses</div>
                                    </div>
                                </div>
                                <p style="margin-top: 15px; font-size: 0.9rem; opacity: 0.9;">
                                    The ${business.industry.toLowerCase()} sector shows strong fundamentals with consistent demand patterns. 
                                    Competition is moderate with opportunities for differentiation through service quality and customer experience.
                                </p>
                            </div>
                        </div>
                        ` : ''}

                        <!-- Location Demographics -->
                        ${isEnterprise ? `
                        <div class="content-section">
                            <h2 class="section-title">📍 Location Analysis <span class="premium-badge">ENTERPRISE</span></h2>
                            <div class="location-stats">
                                <h3>${business.location?.city || 'Unknown'}, ${business.location?.state || 'Unknown'} Demographics</h3>
                                <div class="demo-grid">
                                    <div class="demo-item">
                                        <span>Population:</span>
                                        <strong>127,843</strong>
                                    </div>
                                    <div class="demo-item">
                                        <span>Median Income:</span>
                                        <strong>$68,920</strong>
                                    </div>
                                    <div class="demo-item">
                                        <span>Unemployment:</span>
                                        <strong>3.8%</strong>
                                    </div>
                                    <div class="demo-item">
                                        <span>Business Growth:</span>
                                        <strong>+2.1%</strong>
                                    </div>
                                </div>
                                <p style="margin-top: 15px; font-size: 0.9rem; color: #374151;">
                                    Strong local economy with growing population and stable employment. 
                                    Demographic profile aligns well with target customer base for ${business.industry.toLowerCase()} businesses.
                                </p>
                            </div>
                        </div>
                        ` : ''}
                    </div>

                    <!-- Sidebar -->
                    <div>
                        <!-- SBA Loan Calculator -->
                        <div class="content-section">
                            <h2 class="section-title">🏦 SBA Loan Calculator</h2>
                            <div class="calculator">
                                <div class="calc-inputs">
                                    <div class="input-group">
                                        <label>Purchase Price:</label>
                                        <input type="number" id="purchasePrice" value="${business.financial_data?.asking_price || 0}">
                                    </div>
                                    <div class="input-group">
                                        <label>Down Payment (%):</label>
                                        <input type="number" id="downPayment" value="10" min="10" max="50">
                                    </div>
                                    <div class="input-group">
                                        <label>Interest Rate (%):</label>
                                        <input type="number" id="interestRate" value="8.5" step="0.1" min="1" max="15">
                                    </div>
                                    <div class="input-group">
                                        <label>Loan Term (Years):</label>
                                        <input type="number" id="loanTerm" value="10" min="5" max="25">
                                    </div>
                                </div>
                                <button class="calc-button" onclick="calculateSBALoan()">Calculate Payment</button>
                                <div id="calcResult" class="calc-result" style="display: none;"></div>
                            </div>
                        </div>

                        <!-- Action Items -->
                        <div class="content-section">
                            <h2 class="section-title">🎯 Next Steps</h2>
                            <div style="display: flex; flex-direction: column; gap: 10px;">
                                <button class="calc-button" onclick="saveToWatchlist()" style="background: #059669;">
                                    📌 Save to Watchlist
                                </button>
                                <button class="calc-button" onclick="requestMoreInfo()" style="background: #7c3aed;">
                                    📧 Request Details
                                </button>
                                <button class="calc-button" onclick="scheduleViewing()" style="background: #dc2626;">
                                    📅 Schedule Viewing
                                </button>
                            </div>
                        </div>

                        <!-- Recommended Reading -->
                        <div class="affiliate-section">
                            <h3 style="margin-bottom: 10px; color: #92400e;">📚 Essential Business Acquisition Books</h3>
                            <p style="font-size: 0.875rem; color: #78350f; margin-bottom: 15px;">
                                Expert-recommended books for successful business acquisition:
                            </p>
                            <div id="bookRecommendations" style="display: grid; gap: 12px;">
                                <!-- Books will be populated here -->
                            </div>
                            
                            <!-- Professional Services -->
                            <div style="margin-top: 25px; padding-top: 20px; border-top: 1px solid #f59e0b;">
                                <h4 style="margin-bottom: 15px; color: #92400e;">🤝 Professional Services</h4>
                                <div class="affiliate-links">
                                    <a href="https://www.legalzoom.com/business?utm_source=cashflowfinder" target="_blank" class="affiliate-link">
                                        ⚖️ Legal Services
                                    </a>
                                    <a href="https://www.fundera.com/business-loans/sba-loans?utm_source=cashflowfinder" target="_blank" class="affiliate-link">
                                        💰 SBA Financing
                                    </a>
                                    <a href="https://www.bizplan.com/?utm_source=cashflowfinder" target="_blank" class="affiliate-link">
                                        📋 Due Diligence
                                    </a>
                                    <a href="https://www.score.org/?utm_source=cashflowfinder" target="_blank" class="affiliate-link">
                                        👨‍💼 Business Mentoring
                                    </a>
                                </div>
                            </div>
                            
                            <p style="font-size: 0.75rem; color: #78350f; margin-top: 15px; text-align: center;">
                                Cash Flow Finder earns commission from affiliate partners
                            </p>
                        </div>
                    </div>
                </div>
            `;
            
            // Populate book recommendations
            populateBookRecommendations(recommendations.books || []);
        }

        // Populate book recommendations
        function populateBookRecommendations(books) {
            const container = document.getElementById('bookRecommendations');
            if (!books || books.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #78350f;">
                        📚 Loading personalized book recommendations...
                    </div>
                `;
                return;
            }

            container.innerHTML = books.map(book => `
                <a href="${book.amazon_url}" target="_blank" class="book-item" onclick="trackBookClick('${book.asin}')">
                    <div class="book-cover">📖</div>
                    <div class="book-info">
                        <div class="book-title">${book.title}</div>
                        <div class="book-author">by ${book.author}</div>
                        <div class="book-description">${book.description}</div>
                    </div>
                    <div class="book-relevance">${book.relevance_score}/10</div>
                </a>
            `).join('');
        }

        // Track book clicks for analytics
        function trackBookClick(asin) {
            try {
                fetch('/api/analytics/book-click', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify({ asin, business_id: getBusinessId() })
                });
            } catch (error) {
                console.log('Analytics tracking failed:', error);
            }
        }

        // SBA Loan Calculator
        function calculateSBALoan() {
            const purchasePrice = parseFloat(document.getElementById('purchasePrice').value) || 0;
            const downPaymentPercent = parseFloat(document.getElementById('downPayment').value) || 10;
            const interestRate = parseFloat(document.getElementById('interestRate').value) || 8.5;
            const loanTermYears = parseFloat(document.getElementById('loanTerm').value) || 10;

            const downPaymentAmount = purchasePrice * (downPaymentPercent / 100);
            const loanAmount = purchasePrice - downPaymentAmount;
            const monthlyRate = (interestRate / 100) / 12;
            const numberOfPayments = loanTermYears * 12;

            let monthlyPayment = 0;
            if (monthlyRate > 0) {
                monthlyPayment = loanAmount * (monthlyRate * Math.pow(1 + monthlyRate, numberOfPayments)) / 
                                (Math.pow(1 + monthlyRate, numberOfPayments) - 1);
            } else {
                monthlyPayment = loanAmount / numberOfPayments;
            }

            const totalPayment = monthlyPayment * numberOfPayments;
            const totalInterest = totalPayment - loanAmount;

            document.getElementById('calcResult').style.display = 'block';
            document.getElementById('calcResult').innerHTML = `
                <h4 style="margin-bottom: 10px; color: #059669;">Loan Calculation Results:</h4>
                <div style="display: grid; gap: 8px;">
                    <div style="display: flex; justify-content: space-between;">
                        <span>Loan Amount:</span>
                        <strong>$${loanAmount.toLocaleString()}</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span>Down Payment:</span>
                        <strong>$${downPaymentAmount.toLocaleString()}</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span>Monthly Payment:</span>
                        <strong style="color: #059669;">$${monthlyPayment.toLocaleString()}</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span>Total Interest:</span>
                        <strong>$${totalInterest.toLocaleString()}</strong>
                    </div>
                </div>
            `;
        }

        // Action functions
        function saveToWatchlist() {
            alert('Business saved to your watchlist! (Feature coming soon)');
        }

        function requestMoreInfo() {
            alert('Request sent to business broker! (Feature coming soon)');
        }

        function scheduleViewing() {
            alert('Viewing scheduled! (Feature coming soon)');
        }

        // Initialize
        window.addEventListener('load', () => {
            checkAuth();
        });
    </script>
</body>
</html>